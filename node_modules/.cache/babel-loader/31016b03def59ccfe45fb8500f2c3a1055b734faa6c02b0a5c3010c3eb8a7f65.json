{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect, useCallback } from 'react';\nimport { signInAnonymously, onAuthStateChanged } from 'firebase/auth';\nimport { doc, setDoc, onSnapshot } from 'firebase/firestore';\nimport { auth, db } from '../firebaseConfig'; // Import from our config file\nimport { i18n } from '../i18n';\n\n// Hook for Firebase Auth and Data Loading\nexport function useFirebase(setLang) {\n  _s();\n  const [userId, setUserId] = useState(null);\n  const [isAuthReady, setIsAuthReady] = useState(false);\n  const [userData, setUserData] = useState({\n    bookmarks: [],\n    notes: []\n  });\n  const [error, setError] = useState(null);\n\n  // 1. Authentication\n  useEffect(() => {\n    if (!auth) {\n      console.error(\"Firebase Auth is not initialized.\");\n      setIsAuthReady(true);\n      return;\n    }\n    const unsubscribe = onAuthStateChanged(auth, async user => {\n      if (!user) {\n        console.log(i18n.en.sign_in_guest);\n        try {\n          await signInAnonymously(auth);\n        } catch (e) {\n          console.error(`Anonymous sign-in failed:`, e);\n          setError(i18n.en.error_auth);\n          setIsAuthReady(true);\n        }\n      } else {\n        setUserId(user.uid);\n        setIsAuthReady(true);\n      }\n    });\n\n    // Set initial language based on browser/storage if needed\n    const storedLang = localStorage.getItem('appLang') || 'en';\n    setLang(storedLang);\n    return () => unsubscribe();\n  }, [setLang]);\n\n  // 2. Data Listener (runs once auth is ready)\n  useEffect(() => {\n    if (!isAuthReady || !userId || !db) return;\n\n    // Simplified data path for user data\n    const userDataRef = doc(db, 'users', userId);\n    const unsubscribe = onSnapshot(userDataRef, docSnap => {\n      if (docSnap.exists()) {\n        const data = docSnap.data();\n        setUserData({\n          bookmarks: data.bookmarks || [],\n          notes: data.notes || []\n        });\n      } else {\n        // Initialize user data if it doesn't exist\n        const initialData = {\n          bookmarks: [],\n          notes: []\n        };\n        setDoc(userDataRef, initialData).catch(e => console.error(\"Error initializing user data:\", e));\n        setUserData(initialData);\n      }\n    }, e => {\n      console.error(\"Firestore data snapshot error:\", e);\n      setError(\"Error fetching user data.\");\n    });\n    return () => unsubscribe();\n  }, [isAuthReady, userId]);\n\n  // 3. Data Setter\n  const saveUserData = useCallback(async newUserData => {\n    if (!db || !userId) return;\n    const userDataRef = doc(db, 'users', userId);\n    try {\n      await setDoc(userDataRef, newUserData, {\n        merge: true\n      });\n    } catch (e) {\n      console.error(\"Error saving user data:\", e);\n    }\n  }, [userId]);\n  return {\n    isAuthReady,\n    userId,\n    userData,\n    saveUserData,\n    error\n  };\n}\n_s(useFirebase, \"JkZNc3z6MwEWjj1my9B3q2qfzyU=\");","map":{"version":3,"names":["useState","useEffect","useCallback","signInAnonymously","onAuthStateChanged","doc","setDoc","onSnapshot","auth","db","i18n","useFirebase","setLang","_s","userId","setUserId","isAuthReady","setIsAuthReady","userData","setUserData","bookmarks","notes","error","setError","console","unsubscribe","user","log","en","sign_in_guest","e","error_auth","uid","storedLang","localStorage","getItem","userDataRef","docSnap","exists","data","initialData","catch","saveUserData","newUserData","merge"],"sources":["C:/GitHub/good-news-pwa-gemini/src/hooks/useFirebase.js"],"sourcesContent":["import { useState, useEffect, useCallback } from 'react';\r\nimport { signInAnonymously, onAuthStateChanged } from 'firebase/auth';\r\nimport { doc, setDoc, onSnapshot } from 'firebase/firestore';\r\nimport { auth, db } from '../firebaseConfig'; // Import from our config file\r\nimport { i18n } from '../i18n';\r\n\r\n// Hook for Firebase Auth and Data Loading\r\nexport function useFirebase(setLang) {\r\n    const [userId, setUserId] = useState(null);\r\n    const [isAuthReady, setIsAuthReady] = useState(false);\r\n    const [userData, setUserData] = useState({ bookmarks: [], notes: [] });\r\n    const [error, setError] = useState(null);\r\n\r\n    // 1. Authentication\r\n    useEffect(() => {\r\n        if (!auth) {\r\n            console.error(\"Firebase Auth is not initialized.\");\r\n            setIsAuthReady(true);\r\n            return;\r\n        }\r\n\r\n        const unsubscribe = onAuthStateChanged(auth, async (user) => {\r\n            if (!user) {\r\n                console.log(i18n.en.sign_in_guest);\r\n                try {\r\n                    await signInAnonymously(auth);\r\n                } catch (e) {\r\n                    console.error(`Anonymous sign-in failed:`, e);\r\n                    setError(i18n.en.error_auth);\r\n                    setIsAuthReady(true);\r\n                }\r\n            } else {\r\n                setUserId(user.uid);\r\n                setIsAuthReady(true);\r\n            }\r\n        });\r\n\r\n        // Set initial language based on browser/storage if needed\r\n        const storedLang = localStorage.getItem('appLang') || 'en';\r\n        setLang(storedLang);\r\n\r\n        return () => unsubscribe();\r\n    }, [setLang]);\r\n\r\n    // 2. Data Listener (runs once auth is ready)\r\n    useEffect(() => {\r\n        if (!isAuthReady || !userId || !db) return;\r\n\r\n        // Simplified data path for user data\r\n        const userDataRef = doc(db, 'users', userId);\r\n\r\n        const unsubscribe = onSnapshot(userDataRef, (docSnap) => {\r\n            if (docSnap.exists()) {\r\n                const data = docSnap.data();\r\n                setUserData({\r\n                    bookmarks: data.bookmarks || [],\r\n                    notes: data.notes || [],\r\n                });\r\n            } else {\r\n                // Initialize user data if it doesn't exist\r\n                const initialData = { bookmarks: [], notes: [] };\r\n                setDoc(userDataRef, initialData).catch(e => console.error(\"Error initializing user data:\", e));\r\n                setUserData(initialData);\r\n            }\r\n        }, (e) => {\r\n            console.error(\"Firestore data snapshot error:\", e);\r\n            setError(\"Error fetching user data.\");\r\n        });\r\n\r\n        return () => unsubscribe();\r\n    }, [isAuthReady, userId]);\r\n\r\n    // 3. Data Setter\r\n    const saveUserData = useCallback(async (newUserData) => {\r\n        if (!db || !userId) return;\r\n        const userDataRef = doc(db, 'users', userId);\r\n        try {\r\n            await setDoc(userDataRef, newUserData, { merge: true });\r\n        } catch (e) {\r\n            console.error(\"Error saving user data:\", e);\r\n        }\r\n    }, [userId]);\r\n\r\n    return { isAuthReady, userId, userData, saveUserData, error };\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}