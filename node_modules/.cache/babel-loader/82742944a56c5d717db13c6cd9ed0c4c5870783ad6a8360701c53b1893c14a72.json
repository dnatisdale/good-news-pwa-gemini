{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect, useCallback } from \"react\";\nimport { signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword,\n// New Import\nsignInWithEmailAndPassword,\n// New Import\nsignOut // New Import\n} from \"firebase/auth\";\nimport { doc, setDoc, onSnapshot } from \"firebase/firestore\";\nimport { auth, db } from \"../firebaseConfig\";\nimport { i18n } from \"../i18n\";\n\n// Hook for Firebase Auth and Data Loading\nexport function useFirebase(setLang) {\n  _s();\n  const [userId, setUserId] = useState(null);\n  const [isAuthReady, setIsAuthReady] = useState(false);\n  const [userData, setUserData] = useState({\n    bookmarks: [],\n    notes: []\n  });\n  const [error, setError] = useState(null);\n\n  // 1. Authentication Listener (runs once)\n  useEffect(() => {\n    if (!auth) {\n      console.error(\"Firebase Auth is not initialized.\");\n      setIsAuthReady(true);\n      return;\n    }\n    const unsubscribe = onAuthStateChanged(auth, async user => {\n      if (!user) {\n        // If no user is logged in, sign in anonymously to ensure every user has a UID for data storage.\n        console.log(i18n.en.sign_in_guest);\n        try {\n          await signInAnonymously(auth);\n        } catch (e) {\n          console.error(`Anonymous sign-in failed:`, e);\n          setError(i18n.en.error_auth);\n        }\n      }\n      // User ID is updated here whether it's anonymous or email/password\n      setUserId(user ? user.uid : null);\n      setIsAuthReady(true);\n    });\n    const storedLang = localStorage.getItem(\"appLang\") || \"en\";\n    setLang(storedLang);\n    return () => unsubscribe();\n  }, [setLang]);\n\n  // 2. Data Listener (runs once auth is ready)\n  useEffect(() => {\n    if (!isAuthReady || !userId || !db) return;\n    const userDataRef = doc(db, \"users\", userId);\n    const unsubscribe = onSnapshot(userDataRef, docSnap => {\n      if (docSnap.exists()) {\n        const data = docSnap.data();\n        setUserData({\n          bookmarks: data.bookmarks || [],\n          notes: data.notes || []\n        });\n      } else {\n        // Initialize user data if it doesn't exist\n        const initialData = {\n          bookmarks: [],\n          notes: []\n        };\n        setDoc(userDataRef, initialData).catch(e => console.error(\"Error initializing user data:\", e));\n        setUserData(initialData);\n      }\n    }, e => {\n      console.error(\"Firestore data snapshot error:\", e);\n      setError(\"Error fetching user data.\");\n    });\n    return () => unsubscribe();\n  }, [isAuthReady, userId]);\n\n  // 3. Data Setter\n  const saveUserData = useCallback(async newUserData => {\n    if (!db || !userId) return;\n    const userDataRef = doc(db, \"users\", userId);\n    try {\n      await setDoc(userDataRef, newUserData, {\n        merge: true\n      });\n    } catch (e) {\n      console.error(\"Error saving user data:\", e);\n    }\n  }, [userId]);\n\n  // 4. NEW AUTH FUNCTIONS\n  const signUp = useCallback(async (email, password) => {\n    setError(null);\n    try {\n      await createUserWithEmailAndPassword(auth, email, password);\n      return true; // Success\n    } catch (e) {\n      console.error(\"Sign up failed:\", e);\n      setError(e.message);\n      return false; // Failure\n    }\n  }, []);\n  const signIn = useCallback(async (email, password) => {\n    setError(null);\n    try {\n      await signInWithEmailAndPassword(auth, email, password);\n      return true; // Success\n    } catch (e) {\n      console.error(\"Sign in failed:\", e);\n      setError(e.message);\n      return false; // Failure\n    }\n  }, []);\n  const logOut = useCallback(async () => {\n    await signOut(auth);\n    // Note: The onAuthStateChanged listener will automatically sign them back in anonymously\n  }, []);\n  return {\n    isAuthReady,\n    userId,\n    userData,\n    saveUserData,\n    error,\n    signUp,\n    signIn,\n    logOut\n  };\n}\n_s(useFirebase, \"9ZkbbSE/7ae9+0XwcthwzqRR10c=\");","map":{"version":3,"names":["useState","useEffect","useCallback","signInAnonymously","onAuthStateChanged","createUserWithEmailAndPassword","signInWithEmailAndPassword","signOut","doc","setDoc","onSnapshot","auth","db","i18n","useFirebase","setLang","_s","userId","setUserId","isAuthReady","setIsAuthReady","userData","setUserData","bookmarks","notes","error","setError","console","unsubscribe","user","log","en","sign_in_guest","e","error_auth","uid","storedLang","localStorage","getItem","userDataRef","docSnap","exists","data","initialData","catch","saveUserData","newUserData","merge","signUp","email","password","message","signIn","logOut"],"sources":["C:/GitHub/good-news-pwa-gemini/src/hooks/useFirebase.js"],"sourcesContent":["import { useState, useEffect, useCallback } from \"react\";\r\nimport {\r\n  signInAnonymously,\r\n  onAuthStateChanged,\r\n  createUserWithEmailAndPassword, // New Import\r\n  signInWithEmailAndPassword, // New Import\r\n  signOut, // New Import\r\n} from \"firebase/auth\";\r\nimport { doc, setDoc, onSnapshot } from \"firebase/firestore\";\r\nimport { auth, db } from \"../firebaseConfig\";\r\nimport { i18n } from \"../i18n\";\r\n\r\n// Hook for Firebase Auth and Data Loading\r\nexport function useFirebase(setLang) {\r\n  const [userId, setUserId] = useState(null);\r\n  const [isAuthReady, setIsAuthReady] = useState(false);\r\n  const [userData, setUserData] = useState({ bookmarks: [], notes: [] });\r\n  const [error, setError] = useState(null);\r\n\r\n  // 1. Authentication Listener (runs once)\r\n  useEffect(() => {\r\n    if (!auth) {\r\n      console.error(\"Firebase Auth is not initialized.\");\r\n      setIsAuthReady(true);\r\n      return;\r\n    }\r\n\r\n    const unsubscribe = onAuthStateChanged(auth, async (user) => {\r\n      if (!user) {\r\n        // If no user is logged in, sign in anonymously to ensure every user has a UID for data storage.\r\n        console.log(i18n.en.sign_in_guest);\r\n        try {\r\n          await signInAnonymously(auth);\r\n        } catch (e) {\r\n          console.error(`Anonymous sign-in failed:`, e);\r\n          setError(i18n.en.error_auth);\r\n        }\r\n      }\r\n      // User ID is updated here whether it's anonymous or email/password\r\n      setUserId(user ? user.uid : null);\r\n      setIsAuthReady(true);\r\n    });\r\n\r\n    const storedLang = localStorage.getItem(\"appLang\") || \"en\";\r\n    setLang(storedLang);\r\n\r\n    return () => unsubscribe();\r\n  }, [setLang]);\r\n\r\n  // 2. Data Listener (runs once auth is ready)\r\n  useEffect(() => {\r\n    if (!isAuthReady || !userId || !db) return;\r\n\r\n    const userDataRef = doc(db, \"users\", userId);\r\n\r\n    const unsubscribe = onSnapshot(\r\n      userDataRef,\r\n      (docSnap) => {\r\n        if (docSnap.exists()) {\r\n          const data = docSnap.data();\r\n          setUserData({\r\n            bookmarks: data.bookmarks || [],\r\n            notes: data.notes || [],\r\n          });\r\n        } else {\r\n          // Initialize user data if it doesn't exist\r\n          const initialData = { bookmarks: [], notes: [] };\r\n          setDoc(userDataRef, initialData).catch((e) =>\r\n            console.error(\"Error initializing user data:\", e)\r\n          );\r\n          setUserData(initialData);\r\n        }\r\n      },\r\n      (e) => {\r\n        console.error(\"Firestore data snapshot error:\", e);\r\n        setError(\"Error fetching user data.\");\r\n      }\r\n    );\r\n\r\n    return () => unsubscribe();\r\n  }, [isAuthReady, userId]);\r\n\r\n  // 3. Data Setter\r\n  const saveUserData = useCallback(\r\n    async (newUserData) => {\r\n      if (!db || !userId) return;\r\n      const userDataRef = doc(db, \"users\", userId);\r\n      try {\r\n        await setDoc(userDataRef, newUserData, { merge: true });\r\n      } catch (e) {\r\n        console.error(\"Error saving user data:\", e);\r\n      }\r\n    },\r\n    [userId]\r\n  );\r\n\r\n  // 4. NEW AUTH FUNCTIONS\r\n  const signUp = useCallback(async (email, password) => {\r\n    setError(null);\r\n    try {\r\n      await createUserWithEmailAndPassword(auth, email, password);\r\n      return true; // Success\r\n    } catch (e) {\r\n      console.error(\"Sign up failed:\", e);\r\n      setError(e.message);\r\n      return false; // Failure\r\n    }\r\n  }, []);\r\n\r\n  const signIn = useCallback(async (email, password) => {\r\n    setError(null);\r\n    try {\r\n      await signInWithEmailAndPassword(auth, email, password);\r\n      return true; // Success\r\n    } catch (e) {\r\n      console.error(\"Sign in failed:\", e);\r\n      setError(e.message);\r\n      return false; // Failure\r\n    }\r\n  }, []);\r\n\r\n  const logOut = useCallback(async () => {\r\n    await signOut(auth);\r\n    // Note: The onAuthStateChanged listener will automatically sign them back in anonymously\r\n  }, []);\r\n\r\n  return {\r\n    isAuthReady,\r\n    userId,\r\n    userData,\r\n    saveUserData,\r\n    error,\r\n    signUp,\r\n    signIn,\r\n    logOut,\r\n  };\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}